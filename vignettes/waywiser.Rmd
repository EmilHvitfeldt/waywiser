---
title: "Assessing Models with Waywiser"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Assessing Models with Waywiser}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  eval = rlang::is_installed("vip") && rlang::is_installed("kableExtra")
)
```

The waywiser package aims to be an ergonomic toolbox providing a consistent user 
interface for assessing spatial models. To that end, waywiser does three main 
things:

1. Provides new [yardstick](https://yardstick.tidymodels.org/) extensions, 
   making it easier to use performance metrics from the spatial modeling 
   literature via a standardized API.
2. Provides a new function, `ww_multi_scale()`, which makes it easy to see how
   model performance metrics change when predictions are aggregated to various
   scales.
3. Provides an implementation of the 
   [area of applicability from Meyer and Pebesma 2021](https://doi.org/10.1111/2041-210X.13650),
   extending this tool to work with tidymodels infrastructure.

This vignette will walk through each of these goals in turn. Before we do that, 
let's set up the data we'll use in examples:

```{r setup}
library(waywiser)

worldclim_model <- lm(
  response ~ bio2 + bio10 + bio13 + bio19, 
  worldclim_simulation
)

worldclim_simulation$predictions <- predict(
  worldclim_model,
  worldclim_simulation
)

head(worldclim_simulation)
```

## Yardstick Extensions

First and foremost, waywiser provides a host of new yardstick metrics to provide
a standardized interface for various performance metrics.

All of these functions work more or less the same way: you provide your data,
the names of your "true" values and predicted values, and get back a 
standardized output format. As usual with yardstick, that output can either be
a tibble or a vector output. For instance, if we want to calculate the agreement
coefficient from [Ji and Gallo 2006](https://doi.org/10.14358/PERS.72.7.823):

```{r}
ww_agreement_coefficient(
  worldclim_simulation,
  truth = response,
  estimate = predictions
)

ww_agreement_coefficient_vec(
  truth = worldclim_simulation$response,
  estimate = worldclim_simulation$predictions
)
```

Some of these additional metrics are implemented by wrapping functions from the
[spdep](https://r-spatial.github.io/spdep/) package:

```{r}
ww_global_geary_c(
  worldclim_simulation,
  truth = response,
  estimate = predictions
)
```

These functions rely on calculating the spatial neighbors of each observation.
The waywiser package will automatically use `ww_build_weights()` to calculate
these, if not provided, but this is often not desirable. For that reason, these
functions all have a `wt` argument, which can take either pre-calculated weights
or a function that will create spatial weights:

```{r}
ww_global_geary_c(
  worldclim_simulation,
  truth = response,
  estimate = predictions,
  wt = ww_build_weights(worldclim_simulation)
)

ww_global_geary_c(
  worldclim_simulation,
  truth = response,
  estimate = predictions,
  wt = ww_build_weights
)
```

Because these are yardstick metrics, they can be used with 
`yardstick::metric_set()` and other tidymodels infrastructure:

```{r}
yardstick::metric_set(
  ww_agreement_coefficient,
  ww_global_geary_c
)(worldclim_simulation,
  truth = response,
  estimate = predictions)
```

## Multi-scale model assessment

A common pattern with spatial models is that you need to predict observation
units -- pixels of a raster or individual points -- which will be aggregated to
arbitrary scales, such as towns or parcel boundaries. Because errors can be
spatially distributed, or can either compound or counteract each other when 
aggregated, [some assessment protocols](https://doi.org/10.1016/j.rse.2010.05.010)
recommend assessing model predictions aggregated to multiple scales.

The `ww_multi_scale()` function helps automate this process. The interface for
this function works similarly to that for yardstick metrics -- you provide your
data, your true values, and your estimate -- except you also must provide 
instructions for how to aggregate your data. This can take the form of providing
information on how to build standardized grids, by passing arguments that will
be used by `sf::st_make_grid()`, or by passing polygons directly:

```{r}
ww_multi_scale(
  worldclim_simulation,
  truth = response,
  estimate = predictions,
  metrics = list(ww_agreement_coefficient, yardstick::rmse),
  n = list(2, 4)
)

grid <- sf::st_make_grid(worldclim_simulation, n = 2)
ww_multi_scale(
  worldclim_simulation,
  truth = response,
  estimate = predictions,
  metrics = list(ww_agreement_coefficient, yardstick::rmse),
  grids = list(grid)
)
```

## Area of Applicability

Last but not least, we can also see if there's any areas in our data that are 
too different from our training data for us to safely predict on, which fall 
outside the "area of applicability" defined by 
[Meyer and Pebesma (2021)](https://doi.org/10.1111/2041-210X.13650):

```{r}
worldclim_aoa <- ww_area_of_applicability(
  response ~ bio2 + bio10 + bio13 + bio19,
  worldclim_simulation,
  importance = vip::vi_model(worldclim_model)
)

worldclim_aoa
```

The objects returned by `ww_area_of_applicability()` are models in their own 
right, which can be used by functions such as `predict()` to calculate if new
observations are in the area of applicability of a model. 

## Feature Matrix

Below is a table of the major statistical functions waywiser provides, alongside 
brief descriptions and journal references for each. For a complete list of 
package functions, check out the [package reference page](https://mikemahoney218.github.io/waywiser/reference/index.html).

```{r echo=FALSE}
funs <- tibble::tribble(
  ~ "Function", ~ "Description", ~ "Category", ~ "Reference",
  "ww_area_of_applicability()", "Calculate the 'area of applicability' of a model", "AOA", "H. Meyer and E. Pebesma. 2021. Predicting into unknown space? Estimating the area of applicability of spatial prediction models, Methods in Ecology and Evolution 12(9), pp 1620 - 1633, doi: 10.1111/2041-210X.13650.",
  "ww_multi_scale()", "Calculate model metrics for predictions aggregated to multiple levels", "Multi-scale assessment", "Riemann, R., Wilson, B. T., Lister, A., and Parks, S. (2010) An effective assessment protocol for continuous geospatial datasets of forest characteristics using USFS Forest Inventory and Analysis (FIA) data. Remote Sensing of Environment 114(10), pp 2337-2352, doi: 10.1016/j.rse.2010.05.010.",
  "ww_global_moran_i() (plus _vec and _pvalue variants)", "Calculate Moran's I", "Spatial yardstick metrics", "Moran, P.A.P. (1950). Notes on Continuous Stochastic Phenomena. Biometrika, 37(1/2), pp 17. doi: 10.2307/2332142; Cliff, A. D., Ord, J. K. 1981 Spatial processes, Pion, p. 17.",
  "ww_local_moran_i() (plus _vec and _pvalue variants)", "Calculate local Moran's I (Anselin's LISA)", "Spatial yardstick metrics", "Anselin, L. 1995. Local indicators of spatial association, Geographical Analysis, 27, pp 93–115. doi: 10.1111/j.1538-4632.1995.tb00338.x. Sokal, R. R, Oden, N. L. and Thomson, B. A. 1998. Local Spatial Autocorrelation in a Biological Model. Geographical Analysis, 30, pp 331–354. doi: 10.1111/j.1538-4632.1998.tb00406.x",
  "ww_global_geary_c() (plus _vec and _pvalue variants)", "Calculate Geary's C", "Spatial yardstick metrics", "Geary, R. C. (1954). The Contiguity Ratio and Statistical Mapping. The Incorporated Statistician. 5 (3): 115–145. doi: 10.2307/2986645; Cliff, A. D., Ord, J. K. 1981 Spatial processes, Pion, p. 17.",
  "ww_local_geary_c() (plus _vec and _pvalue variants)", "Calculate local Geary's C", "Spatial yardstick metrics", "Anselin, L. 1995. Local indicators of spatial association, Geographical Analysis, 27, pp 93–115. doi: 10.1111/j.1538-4632.1995.tb00338.x. Anselin, L. 2019. A Local Indicator of Multivariate Spatial Association: Extending Geary's C. Geographical Analysis, 51, pp 133-150. doi: 10.1111/gean.12164",
  "ww_local_getis_ord_g() (plus _vec and _pvalue variants)", "Calculate local Getis-Ord G and G*", "Spatial yardstick metrics", "Ord, J. K. and Getis, A. 1995. Local spatial autocorrelation statistics: distributional issues and an application. Geographical Analysis, 27, 286–306. doi: 10.1111/j.1538-4632.1995.tb00912.x",
  "ww_agreement_coefficient(), ww_systematic_agreement_coefficient(), ww_systematic_mpd(), ww_systematic_rmpd() (plus unsystematic and _vec variants)", "Calculate agreement coefficients and related metrics", "Yardstick metrics", "Ji, L. and Gallo, K. 2006. An Agreement Coefficient for Image Comparison. Photogrammetric Engineering & Remote Sensing 72(7), pp 823–833, doi: 10.14358/PERS.72.7.823.",
  "ww_willmott_d(), ww_willmott_dr(), ww_systematic_mse(), ww_systematic_rmse() (plus unsystematic and _vec variants)", "Calculate Willmott's d and related metrics", "Yardstick metrics", "Willmott, C. J. 1981. On the Validation of Models. Physical Geography 2(2), pp 184-194, doi: 10.1080/02723646.1981.10642213; Willmott, C. J. 1982. Some Comments on the Evaluation of Model Performance. Bulletin of the American Meteorological Society 63(11), pp 1309-1313, doi: 10.1175/1520-0477(1982)063<1309:SCOTEO>2.0.CO;2.; Willmott, C. J., Robeson, S. M., and Matsuura, K. A refined index of model performance. International Journal of Climatology 32, pp 2088-2094, doi: 10.1002/joc.2419.",
)

kableExtra::kable_styling(
  kableExtra::kbl(funs),
  bootstrap_options = c("striped", "hover")
)
```

